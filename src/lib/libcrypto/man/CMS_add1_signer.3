.\" $OpenBSD: CMS_add1_signer.3,v 1.3 2019/08/10 23:41:22 schwarze Exp $
.\" full merge up to: OpenSSL e9b77246 Jan 20 19:58:49 2017 +0100
.\"
.\" This file was written by Dr. Stephen Henson <steve@openssl.org>.
.\" Copyright (c) 2008 The OpenSSL Project.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\"
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\"
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in
.\"    the documentation and/or other materials provided with the
.\"    distribution.
.\"
.\" 3. All advertising materials mentioning features or use of this
.\"    software must display the following acknowledgment:
.\"    "This product includes software developed by the OpenSSL Project
.\"    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"
.\"
.\" 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to
.\"    endorse or promote products derived from this software without
.\"    prior written permission. For written permission, please contact
.\"    openssl-core@openssl.org.
.\"
.\" 5. Products derived from this software may not be called "OpenSSL"
.\"    nor may "OpenSSL" appear in their names without prior written
.\"    permission of the OpenSSL Project.
.\"
.\" 6. Redistributions of any form whatsoever must retain the following
.\"    acknowledgment:
.\"    "This product includes software developed by the OpenSSL Project
.\"    for use in the OpenSSL Toolkit (http://www.openssl.org/)"
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY
.\" EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
.\" PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR
.\" ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
.\" SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
.\" NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
.\" LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
.\" STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
.\" ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
.\" OF THE POSSIBILITY OF SUCH DAMAGE.
.\"
.Dd $Mdocdate: August 10 2019 $
.Dt CMS_ADD1_SIGNER 3
.Os
.Sh NAME
.Nm CMS_add1_signer ,
.Nm CMS_SignerInfo_sign
.Nd add a signer to a CMS_ContentInfo signed data structure
.Sh SYNOPSIS
.In openssl/cms.h
.Ft CMS_SignerInfo *
.Fo CMS_add1_signer
.Fa "CMS_ContentInfo *cms"
.Fa "X509 *signcert"
.Fa "EVP_PKEY *pkey"
.Fa "const EVP_MD *md"
.Fa "unsigned int flags"
.Fc
.Ft int
.Fo CMS_SignerInfo_sign
.Fa "CMS_SignerInfo *si"
.Fc
.Sh DESCRIPTION
.Fn CMS_add1_signer
adds a signer with certificate
.Fa signcert
and private key
.Fa pkey
using message digest
.Fa md
to the
.Vt CMS_ContentInfo
SignedData structure
.Fa cms .
.Pp
The
.Vt CMS_ContentInfo
structure should be obtained from an initial call to
.Xr CMS_sign 3
with the flag
.Dv CMS_PARTIAL
set or in the case or re-signing a valid
.Vt CMS_ContentInfo
SignedData structure.
.Pp
If the
.Fa md
parameter is
.Dv NULL ,
then the default digest for the public key algorithm will be used.
.Pp
Unless the
.Dv CMS_REUSE_DIGEST
flag is set, the returned
.Vt CMS_ContentInfo
structure is not complete and must be finalized either by streaming
(if applicable) or a call to
.Xr CMS_final 3 .
.Pp
The
.Fn CMS_SignerInfo_sign
function will explicitly sign a
.Vt CMS_SignerInfo
structure.
Its main use is when the
.Dv CMS_REUSE_DIGEST
and
.Dv CMS_PARTIAL
flags are both set.
.Pp
The main purpose of
.Fn CMS_add1_signer
is to provide finer control over a CMS signed data structure where the
simpler
.Xr CMS_sign 3
function defaults are not appropriate, for example if multiple signers
or non default digest algorithms are needed.
New attributes can also be added using the returned
.Vt CMS_SignerInfo
structure and the CMS attribute utility functions or the CMS signed
receipt request functions.
.Pp
Any of the following flags (OR'ed together) can be passed in the
.Fa flags
parameter:
.Bl -tag -width Ds
.It Dv CMS_REUSE_DIGEST
Attempt to copy the content digest value from the
.Vt CMS_ContentInfo
structure to add a signer to an existing structure.
An error occurs if a matching digest value cannot be found to copy.
The returned
.Vt CMS_ContentInfo
structure will be valid and finalized when this flag is set.
.It Dv CMS_PARTIAL
If this flag is set in addition to
.Dv CMS_REUSE_DIGEST ,
then the
.Vt CMS_SignerInfo
structure will not be finalized so additional attributes can be added.
In this case an explicit call to
.Fn CMS_SignerInfo_sign
is needed to finalize it.
.It Dv CMS_NOCERTS
Do not include the signer's certificate in the
.Vt CMS_ContentInfo
structure.
The signer's certificate must still be supplied in the
.Fa signcert
parameter though.
This can reduce the size of the signature if the signer's certificate can
be obtained by other means, for example from a previously signed message.
.Pp
The SignedData structure includes several CMS signedAttributes including
the signing time, the CMS content type and the supported list of ciphers
in an SMIMECapabilities attribute.
.It Dv CMS_NOATTR
Use no signedAttributes.
.It Dv CMS_NOSMIMECAP
Omit just the SMIMECapabilities.
.It Dv CMS_USE_KEYID
Use the subject key identifier value to identify signing certificates.
An error occurs if the signing certificate does not have a subject key
identifier extension.
By default, issuer name and serial number are used instead.
.El
.Pp
If present, the SMIMECapabilities attribute indicates support for the
following algorithms in preference order: 256 bit AES, Gost R3411-94,
Gost 28147-89, 192 bit AES, 128 bit AES, triple DES, 128 bit RC2, 64 bit
RC2, DES and 40 bit RC2.
If any of these algorithms is not available then it will not be
included: for example the GOST algorithms will not be included if
the GOST ENGINE is not loaded.
.Pp
.Fn CMS_add1_signer
returns an internal pointer to the
.Vt CMS_SignerInfo
structure just added.
This can be used to set additional attributes before it is finalized.
.Sh RETURN VALUES
.Fn CMS_add1_signer
returns an internal pointer to the
.Vt CMS_SignerInfo
structure just added or
.Dv NULL
if an error occurs.
.Sh SEE ALSO
.Xr CMS_final 3 ,
.Xr CMS_sign 3 ,
.Xr ERR_get_error 3
.Sh HISTORY
.Fn CMS_add1_signer
was added to OpenSSL 0.9.8.
